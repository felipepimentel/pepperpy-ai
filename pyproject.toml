[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

[tool.poetry]
name = "pepperpy"
version = "1.2.0"
description = "A Python library for building AI agents"
authors = ["Felipe Pimentel <fpimentel88@gmail.com>"]
readme = "README.md"
packages = [{ include = "pepperpy" }]

[tool.poetry.dependencies]
python = ">=3.12,<3.13"
aiohttp = ">=3.11.11,<4.0.0"
jinja2 = ">=3.1.5,<4.0.0"
structlog = ">=25.1.0,<26.0.0"
pyyaml = ">=6.0.2,<7.0.0"
python-dotenv = ">=1.0.1,<2.0.0"
markdown = ">=3.7.0,<4.0.0"
pydantic-settings = ">=2.7.1,<3.0.0"
loguru = ">=0.7.3,<1.0.0"
pydantic = ">=2.10.6,<3.0.0"
pyright = ">=1.1.393,<2.0.0"
openai = { version = ">=1.61.0,<2.0.0", optional = true }
anthropic = { version = ">=0.45.2,<0.46.0", optional = true }
google-generativeai = { version = ">=0.8.4,<0.9.0", optional = true }
beautifulsoup4 = { version = ">=4.12.3,<5.0.0", optional = true }
requests = { version = ">=2.32.3,<3.0.0", optional = true }
pymupdf = { version = ">=1.25.2,<2.0.0", optional = true }

[tool.poetry.group.dev.dependencies]
pytest = "^8.3.4"
pytest-asyncio = "^0.25.3"
pytest-cov = "^6.0.0"
pytest-mock = "^3.14.0"
black = "^25.1.0"
ruff = "^0.9.4"
mypy = "^1.14.1"
types-pyyaml = "^6.0.12.20241230"
pydeps = "^3.0.0"
pylint = "^3.3.4"
isort = "^6.0.0"
pre-commit = "^4.1.0"
bandit = "^1.7.4"

[tool.poetry.extras]
openai = ["openai"]
anthropic = ["anthropic"]
google = ["google-generativeai"]
docs = ["pymupdf", "beautifulsoup4", "requests"]
all = [
    "openai",
    "anthropic",
    "google-generativeai",
    "pymupdf",
    "beautifulsoup4",
    "requests",
]

[tool.black]
line-length = 88
target-version = ["py312"]
include = '\.pyi?$'
extend-exclude = '''
^/docs/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
line_length = 88
force_single_line = false
combine_as_imports = true
combine_star = true
lines_between_types = 1
extend_skip = [
    ".git",
    ".venv",
    "__pycache__",
    ".pytest_cache",
    ".mypy_cache",
    "docs/",
]
known_first_party = ["pepperpy"]
known_third_party = ["pytest", "pydantic", "loguru", "yaml"]

[tool.ruff]
line-length = 88
target-version = "py312"
fix = true
unsafe-fixes = false
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    ".pytest_cache",
    ".mypy_cache",
    "build",
    "dist",
    "docs",
]
select = ["E", "F", "W", "B", "C", "D", "ANN", "I", "N", "UP", "RUF"]
ignore = ["E203", "E731", "D100", "D104", "D107"]

[tool.ruff.mccabe]
max-complexity = 10

[tool.ruff.pydocstyle]
convention = "google"

[tool.ruff.per-file-ignores]
"tests/*" = ["S101", "ANN", "D"]
"pepperpy/types.py" = ["D"]
"pepperpy/capabilities/rag/**/*" = ["F401", "F403"]
"pepperpy/embeddings/providers/**/*" = ["F401", "F403"]
"pepperpy/providers/**/*" = ["F401", "F403"]
"pepperpy/teams/providers/**/*" = ["F401", "F403"]
"pepperpy/providers/provider.py" = ["N805"]

[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
disallow_untyped_decorators = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
strict_equality = true
plugins = ["pydantic.mypy"]

[pydantic-mypy]
init_forbid_extra = true
init_typed = true
warn_required_dynamic_aliases = true
warn_untyped_fields = true

[[tool.mypy.overrides]]
module = "pytest.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "loguru.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "google.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "pepperpy.memory.stores.*"
disable_error_code = ["type-arg", "attr-defined"]

[[tool.mypy.overrides]]
module = "pepperpy.core.*"
disable_error_code = ["attr-defined"]

[[tool.mypy.overrides]]
module = "pepperpy.providers.*"
disable_error_code = ["attr-defined", "union-attr"]

[[tool.mypy.overrides]]
module = "pepperpy.monitoring.*"
disable_error_code = ["attr-defined"]

[[tool.mypy.overrides]]
module = "pepperpy.capabilities.*"
disable_error_code = ["attr-defined", "misc"]

[[tool.mypy.overrides]]
module = "tests.*"
disable_error_code = ["no-untyped-def", "misc", "arg-type", "union-attr"]

[[tool.mypy.overrides]]
module = "semantic_kernel.*"
ignore_missing_imports = true
disable_error_code = ["attr-defined", "misc"]


[tool.coverage.run]
branch = true
source = ["pepperpy"]
omit = [
    "tests/*",
    "setup.py",
    "conftest.py",
    "*/__init__.py",
    "*/migrations/*",
    "*/settings/*",
    "*/wsgi.py",
    "*/asgi.py",
    "*/manage.py",
    "*/apps.py",
    "*/urls.py",
    "*/admin.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "raise NotImplementedError",
    "if __name__ == .__main__:",
    "pass",
    "raise AssertionError",
    "raise NotImplementedError",
    "if TYPE_CHECKING:",
    "@abstractmethod",
    "@overload",
]
fail_under = 10
ignore_errors = true

[tool.coverage.html]
directory = "coverage_html"

[tool.coverage.xml]
output = "coverage.xml"

[tool.pytest.ini_options]
minversion = "8.0"
addopts = """
    --strict-markers
    --strict-config
    --asyncio-mode=auto
    --cov=pepperpy
    --cov-report=term-missing
    --cov-report=xml
    --cov-branch
    --no-cov-on-fail
    -v
"""
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
norecursedirs = [".git", ".tox", ".env", "venv", "build", "dist", "*.egg-info"]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
    "memory: marks tests that use memory stores",
    "redis: marks tests that require Redis",
    "vector: marks tests that use vector stores",
    "performance: marks tests as performance tests",
]
console_output_style = "progress"
log_cli = true
log_cli_level = "INFO"
log_cli_format = "%(asctime)s [%(levelname)8s] %(message)s (%(filename)s:%(lineno)s)"
log_cli_date_format = "%Y-%m-%d %H:%M:%S"

[tool.tox]
legacy_tox_ini = """
[tox]
isolated_build = True
envlist = py312, lint, type, security

[testenv]
deps =
    pytest
    pytest-asyncio
    pytest-cov
commands =
    pytest {posargs:tests}

[testenv:lint]
deps =
    black
    isort
    ruff
commands =
    black pepperpy tests
    isort pepperpy tests
    ruff check pepperpy tests

[testenv:type]
deps =
    mypy
    types-all
commands =
    mypy pepperpy tests

[testenv:security]
deps =
    bandit
commands =
    bandit -r pepperpy -c .bandit
"""

[tool.semantic_release]
version_variables = ["pyproject.toml:version"]
commit_author = "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
commit_parser = "angular"
branch = "main"
upload_to_pypi = true
build_command = "poetry build"
repository = "pepperpy-ai"
repository_owner = "felipepimentel"

[tool.semantic_release.remote]
type = "github"
token = "${GH_TOKEN}"

[tool.semantic_release.publish]
dist_glob_patterns = ["dist/*"]
upload_to_vcs_release = true
upload_to_repository = true

[tool.semantic_release.branches.main]
match = "main"
prerelease_token = "rc"
prerelease = false

[tool.semantic_release.publish.pypi]
build = true
remove_dist = true
token = "${POETRY_PYPI_TOKEN_PYPI}"
