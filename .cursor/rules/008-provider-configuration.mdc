---
title: Provider Configuration
description: USE WHEN configuring or using providers to ensure proper environment variable handling and provider abstraction
globs: 
  - "pepperpy/**/*.py"
  - "plugins/**/*.py"
priority: 920
---

# Provider Configuration and Environment Variables

## Overview

This rule defines the standards for configuring and using providers in the PepperPy framework. It ensures proper handling of environment variables, configuration validation, and provider abstractions.

## Auto-binding Configuration

PepperPy's provider configuration is now automatically bound to instance attributes based on the configuration schema defined in `plugin.yaml`:

### Configuration Schema in plugin.yaml

```yaml
# Configuration schema
config_schema:
  api_key:
    description: "API key for the service"
    required: true
    env_var: "SERVICE_API_KEY"
    type: "string"
  temperature:
    description: "Sampling temperature"
    required: false
    default: 0.7
    type: "float"
    min: 0.0
    max: 2.0
  max_tokens:
    description: "Maximum tokens"
    required: false
    default: 1024
    type: "integer"
    min: 1
```

### Using Auto-bound Configuration

```python
# CORRECT - Using auto-bound attributes
class MyProvider(DomainProvider, ProviderPlugin):
    async def generate(self, prompt, **kwargs):
        # Attributes are automatically bound from configuration
        # with proper type conversion
        temperature = kwargs.get("temperature", self.temperature)
        max_tokens = kwargs.get("max_tokens", self.max_tokens)
        
        # Use the attributes
        response = await self.client.complete(
            prompt, 
            temperature=temperature,
            max_tokens=max_tokens
        )
        
        return response
```

## Environment Variable Hierarchy

The framework automatically resolves environment variables based on a consistent hierarchy:

1. `PEPPERPY_{CATEGORY}__{PROVIDER}__{KEY}` (most specific)
2. `{PROVIDER}_{KEY}` (provider-specific)
3. `PEPPERPY_{KEY}` (general)

Example:
- `PEPPERPY_LLM__OPENAI__API_KEY` (most specific)
- `OPENAI_API_KEY` (provider-specific)
- `PEPPERPY_API_KEY` (general)

### Configuration Loading Precedence

When a provider is instantiated, the configuration is loaded with this precedence:

1. Explicitly passed parameters (highest precedence)
2. Environment variables according to hierarchy
3. Default values from `plugin.yaml`

## âŒ Anti-patterns

### Manual Environment Variable Access

```python
# WRONG - Direct environment variable access
import os

class MyProvider(BaseProvider):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        # WRONG - Framework handles environment variables
        self.api_key = os.getenv("MY_API_KEY")
```

### Manual Configuration Access

```python
# WRONG - Direct config access
class MyProvider(BaseProvider):
    async def generate(self, prompt, **kwargs):
        # WRONG - Should use auto-bound attributes
        temperature = kwargs.get(
            "temperature", 
            self._config.get("temperature", 0.7)
        )
```

### Manual Type Conversion

```python
# WRONG - Manual type conversion
class MyProvider(BaseProvider):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        
        # WRONG - Auto-binding handles type conversion
        temp = self._config.get("temperature")
        try:
            self.temperature = float(temp) if temp is not None else 0.7
        except ValueError:
            raise ConfigError("temperature must be a number")
```

## Key Principles

1. **Single Source of Truth**: Define configuration schema only in `plugin.yaml`
2. **Auto-binding**: Use attributes bound automatically by the framework
3. **Type Safety**: Framework handles type conversion and validation
4. **Centralized Validation**: Framework validates configuration
5. **Consistent Environment Variables**: Follow the environment variable hierarchy

## Provider Configuration Patterns

### Plugin Factory Usage

```python
# CORRECT - Using the provider factory
from pepperpy import create_provider

# Framework will load environment variables according to hierarchy
provider = create_provider("llm", "openai")

# Or with explicit configuration
provider = create_provider("llm", "openai", api_key="my-key", temperature=0.8)
```

### Provider Implementation

```python
# CORRECT - Simple provider implementation
class MyProvider(DomainProvider, ProviderPlugin):
    async def initialize(self) -> None:
        """Initialize the provider."""
        if self.initialized:
            return
            
        # Check required configurations - auto-bound from plugin.yaml
        if not hasattr(self, "api_key") or not self.api_key:
            raise ConfigError("API key is required")
            
        # Initialize client
        try:
            self.client = SomeClient(api_key=self.api_key)
        except Exception as e:
            raise ProviderError(f"Failed to initialize client: {e}") from e
```

## Configuration Schema Definition

The `plugin.yaml` file should define a complete configuration schema:

```yaml
# Configuration schema with full details
config_schema:
  api_key:
    description: "API key for authentication"
    required: true
    env_var: "SERVICE_API_KEY"
    type: "string"
    secret: true  # Indicates this is sensitive data
  
  endpoint:
    description: "API endpoint"
    required: false
    default: "https://api.example.com"
    type: "string"
    format: "url"  # Optional format validation
  
  timeout:
    description: "Request timeout in seconds"
    required: false
    default: 30
    type: "integer"
    min: 1
    max: 300
  
  temperature:
    description: "Sampling temperature"
    required: false
    default: 0.7
    type: "float"
    min: 0.0
    max: 2.0
```

## Implementation Checklist

When implementing or using providers:

- [ ] Define complete configuration schema in `plugin.yaml`
- [ ] Use auto-bound attributes in provider code
- [ ] Let the framework handle environment variables
- [ ] Validate required configuration in `initialize()`
- [ ] Handle type conversion via the schema

## User Configuration Example

```python
from pepperpy import PepperPy

# Using environment variables for configuration
app = PepperPy().with_llm(provider_type="openai")

# Or with explicit configuration
app = PepperPy().with_llm(
    provider_type="openai",
    api_key="my-key",
    temperature=0.8
)

async with app as pepper:
    response = await pepper.ask("What's the weather like?")
```

This approach ensures that provider configuration is handled consistently, with proper environment variable resolution, type conversion, and validation. 