---
title: PepperPy Plugin Implementation Guidelines
description: USE WHEN implementing or modifying any provider or plugin in the PepperPy framework
globs: 
  - "plugins/**/*.py"
priority: 800
---

# PepperPy Plugin Implementation Guidelines

## Core Principles

1. **Single Source of Truth**: O arquivo `plugin.yaml` é a ÚNICA fonte de verdade para metadados e esquema de configuração
2. **Duas Classes de Configuração**: Distingua entre:
   - **Variáveis de Ambiente**: Como `api_key`, que podem vir de variáveis de ambiente (não devem ter fallbacks no código)
   - **Valores Fixos**: Como `base_url`, que podem ter valores padrão hardcoded no código
3. **Auto-Binding**: Use atributos auto-bound do plugin.yaml, implementando fallbacks apenas para valores fixos
4. **Proper Inheritance**: Sempre herde de `DomainProvider` e `ProviderPlugin` (e.g., `LLMProvider, ProviderPlugin`)
5. **Default Values**: Defina valores padrão no plugin.yaml via `default_config` para configurações dinâmicas
6. **State Management**: O framework gerencia o estado, não reimplemente isso
7. **Factory Methods**: Cada plugin deve implementar seu próprio método de classe `from_config` para criar instâncias

## Anti-patterns (NEVER DO THESE)

### ❌ Duplicating Metadata

```python
# WRONG - Duplicating metadata that's already in plugin.yaml
class MyProvider(LLMProvider, ProviderPlugin):
    plugin_name = "My Provider"  # WRONG!
    plugin_version = "0.1.0"     # WRONG!
    plugin_category = "llm"      # WRONG!
    provider_type = "myprovider" # WRONG!
```

### ❌ Manual Configuration Fallbacks for Environment Variables

```python
# WRONG - Implementing fallbacks in code for api_key
def __init__(self, **kwargs):
    super().__init__(**kwargs)
    
    # WRONG! Framework handles environment variables:
    if not hasattr(self, "api_key") or self.api_key is None:
        self.api_key = os.environ.get("API_KEY")  # WRONG! Use env_var in plugin.yaml
```

### ❌ Manual State Management

```python
# WRONG - Managing initialization state
async def cleanup(self) -> None:
    """Clean up resources."""
    self.client = None
    self.initialized = False  # WRONG! Framework manages this
```

### ❌ Missing Defaults for Fixed Values

```python
# WRONG - Not providing defaults for fixed values
class MyProvider(LLMProvider, ProviderPlugin):
    api_key: str
    base_url: str  # WRONG! Should have default: base_url: str = "https://api.example.com"
    
    async def initialize(self) -> None:
        if not hasattr(self, "base_url"):  # WRONG!
            self.base_url = "https://api.example.com"  # WRONG!
```

## Correct Implementation

### ✅ Minimal Correct Structure

```python
from typing import Any, Type, TypeVar, cast

T = TypeVar('T', bound='MyProvider')

class MyProvider(LLMProvider, ProviderPlugin):
    """Provider implementation."""
    
    # Variáveis de ambiente (não devem ter valor padrão no código)
    api_key: str
    
    # Valores fixos (devem ter valor padrão no código como fallback)
    base_url: str = "https://api.example.com/v1"
    model: str = "default-model"
    temperature: float = 0.7
    max_tokens: int = 1024
    client: Optional[SomeClient] = None

    def __init__(self, **kwargs: Any) -> None:
        """Initialize the provider."""
        super().__init__(**kwargs)
        self.client = None
        
        # Para valores fixos, garantir que estão definidos
        if 'base_url' in kwargs:
            self.base_url = kwargs['base_url']
        if 'model' in kwargs:
            self.model = kwargs['model']
    
    @classmethod
    def from_config(cls: Type[T], **config: Any) -> T:
        """Create provider instance from configuration."""
        return cast(T, cls(**config))
    
    async def initialize(self) -> None:
        """Initialize provider resources."""
        self.client = SomeClient(api_key=self.api_key)
        
    async def generate(self, messages, **kwargs):
        """Generate content."""
        # Use auto-bound attributes from plugin.yaml 
        temperature = kwargs.get("temperature", self.temperature)
        model = kwargs.get("model", self.model)
        # Implementation...
        
    async def cleanup(self) -> None:
        """Clean up provider resources."""
        if self.client:
            await self.client.aclose()
            self.client = None
```

### ✅ Default Values in plugin.yaml

```yaml
# In plugin.yaml:
default_config:
  model: "gpt-3.5-turbo"
  temperature: 0.7
  max_tokens: 1024
  base_url: "https://api.example.com/v1"  # Mesmo para valores fixos, defina padrões aqui
```

## Implementation Checklist

- [ ] Herda de `DomainProvider, ProviderPlugin`
- [ ] Declara atributos auto-bound com type annotations
- [ ] Distingue entre variáveis de ambiente (sem padrão) e valores fixos (com padrão)
- [ ] Implementa método de classe `from_config` para criação de instâncias
- [ ] NÃO duplica metadados do plugin.yaml
- [ ] NÃO implementa fallbacks manuais para variáveis de ambiente
- [ ] Inicialização limpa: apenas chama super() e inicializa client=None
- [ ] Implementa apenas métodos específicos do provider
- [ ] NÃO gerencia manualmente o estado de inicialização

## Correct plugin.yaml Example

```yaml
name: "OpenAI LLM Provider"
version: "0.1.0"
description: "Provider for the OpenAI GPT models"
author: "PepperPy Team"
plugin_category: "llm"
provider_type: "openai"
required_config_keys:
  - "api_key"

default_config:
  model: "gpt-3.5-turbo"
  temperature: 0.7
  max_tokens: 1024
  base_url: "https://api.openai.com/v1"

config_schema:
  api_key:
    description: "OpenAI API key"
    required: true
    env_var: "OPENAI_API_KEY"
    type: "string"
  model:
    description: "Model to use"
    required: false
    default: "gpt-3.5-turbo"
    type: "string"
  base_url:
    description: "API base URL"
    required: false
    default: "https://api.openai.com/v1"
    type: "string"
```

## Remember

- O framework gerencia auto-binding de atributos
- O framework gerencia carregamento de configuração
- O framework gerencia estado de inicialização
- Nunca implemente workarounds para "consertar" problemas do framework
- Se o framework tem um problema, reporte e conserte no framework!
- Valores fixos (como base_url) devem ter valor padrão no código E no plugin.yaml 