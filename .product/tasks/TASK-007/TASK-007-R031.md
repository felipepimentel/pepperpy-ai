---
title: Implementa√ß√£o de Processadores Especializados
task: TASK-007
code: R031
status: üìã To Do
created: 2024-02-26
updated: 2024-02-26
started: null
completed: null
---

# Requirement
Implementar processadores especializados que estendam o sistema base de processamento (R030) para lidar com tipos espec√≠ficos de conte√∫do, como markdown, JSON, YAML, e outros formatos estruturados.

# Dependencies
- R030 (Consolida√ß√£o do Sistema de Processamento) - Sistema base de processamento
- R024 (Consolida√ß√£o do Sistema de Observabilidade) - Para integrar m√©tricas e logging

## Current State
```python
# Processamento de formatos espec√≠ficos disperso:
# - processors/markdown.py
# - processors/json.py
# - processors/yaml.py
# - processors/xml.py

# Inconsist√™ncias em processamento:
# - Diferentes padr√µes de parsing
# - Diferentes padr√µes de valida√ß√£o
# - Diferentes padr√µes de formata√ß√£o
# - Falta de tratamento de erros padronizado
```

## Implementation
```python
# 1. Implementar processadores especializados
from pepperpy.processing.base import BaseProcessor, ProcessingContext, ProcessingResult
from typing import Any, Dict, List, Optional, Union
import json
import yaml
import markdown
import xml.etree.ElementTree as ET

class MarkdownProcessor(BaseProcessor[str, str]):
    """Process markdown content."""
    
    async def process(
        self,
        content: str,
        context: ProcessingContext
    ) -> ProcessingResult[str]:
        try:
            start_time = time.time()
            html = markdown.markdown(
                content,
                extensions=self.config.get("extensions", [])
            )
            duration = time.time() - start_time
            return ProcessingResult(
                content=html,
                metadata={"type": "markdown", "format": "html"},
                duration=duration
            )
        except Exception as e:
            raise ProcessorError(
                "Failed to process markdown",
                processor_type="markdown",
                details={"error": str(e)}
            ) from e
    
    async def validate(
        self,
        content: str,
        context: ProcessingContext
    ) -> bool:
        # Validar markdown
        return True

class JsonProcessor(BaseProcessor[str, Dict[str, Any]]):
    """Process JSON content."""
    
    async def process(
        self,
        content: str,
        context: ProcessingContext
    ) -> ProcessingResult[Dict[str, Any]]:
        try:
            start_time = time.time()
            data = json.loads(content)
            duration = time.time() - start_time
            return ProcessingResult(
                content=data,
                metadata={"type": "json"},
                duration=duration
            )
        except json.JSONDecodeError as e:
            raise ProcessorError(
                "Failed to process JSON",
                processor_type="json",
                details={"error": str(e), "position": e.pos}
            ) from e
    
    async def validate(
        self,
        content: str,
        context: ProcessingContext
    ) -> bool:
        try:
            json.loads(content)
            return True
        except json.JSONDecodeError:
            return False

class YamlProcessor(BaseProcessor[str, Dict[str, Any]]):
    """Process YAML content."""
    
    async def process(
        self,
        content: str,
        context: ProcessingContext
    ) -> ProcessingResult[Dict[str, Any]]:
        try:
            start_time = time.time()
            data = yaml.safe_load(content)
            duration = time.time() - start_time
            return ProcessingResult(
                content=data,
                metadata={"type": "yaml"},
                duration=duration
            )
        except yaml.YAMLError as e:
            raise ProcessorError(
                "Failed to process YAML",
                processor_type="yaml",
                details={"error": str(e)}
            ) from e
    
    async def validate(
        self,
        content: str,
        context: ProcessingContext
    ) -> bool:
        try:
            yaml.safe_load(content)
            return True
        except yaml.YAMLError:
            return False

class XmlProcessor(BaseProcessor[str, ET.Element]):
    """Process XML content."""
    
    async def process(
        self,
        content: str,
        context: ProcessingContext
    ) -> ProcessingResult[ET.Element]:
        try:
            start_time = time.time()
            root = ET.fromstring(content)
            duration = time.time() - start_time
            return ProcessingResult(
                content=root,
                metadata={"type": "xml"},
                duration=duration
            )
        except ET.ParseError as e:
            raise ProcessorError(
                "Failed to process XML",
                processor_type="xml",
                details={"error": str(e)}
            ) from e
    
    async def validate(
        self,
        content: str,
        context: ProcessingContext
    ) -> bool:
        try:
            ET.fromstring(content)
            return True
        except ET.ParseError:
            return False

# 2. Registrar processadores no registry
async def register_specialized_processors(registry: ProcessorRegistry) -> None:
    """Register specialized processors."""
    await registry.register("markdown", MarkdownProcessor)
    await registry.register("json", JsonProcessor)
    await registry.register("yaml", YamlProcessor)
    await registry.register("xml", XmlProcessor)

# 3. Implementar f√°brica de processadores
class ProcessorFactory:
    """Factory for creating processors."""
    
    def __init__(self, registry: ProcessorRegistry) -> None:
        self._registry = registry
    
    async def create_processor(
        self,
        content_type: str,
        config: Optional[Dict[str, Any]] = None
    ) -> BaseProcessor:
        """Create processor for content type."""
        config = config or {}
        return await self._registry.get_processor(content_type, config)

# 4. Implementar utilit√°rios de processamento
class ProcessingUtils:
    """Utilities for content processing."""
    
    @staticmethod
    def detect_content_type(content: str) -> str:
        """Detect content type from content."""
        content = content.strip()
        if content.startswith("{") and content.endswith("}"):
            return "json"
        if content.startswith("---") or content.startswith("```yaml"):
            return "yaml"
        if content.startswith("<?xml") or content.startswith("<"):
            return "xml"
        if "```" in content or "#" in content:
            return "markdown"
        return "text"
    
    @staticmethod
    def validate_schema(
        data: Dict[str, Any],
        schema: Dict[str, Any]
    ) -> bool:
        """Validate data against JSON schema."""
        try:
            jsonschema.validate(data, schema)
            return True
        except jsonschema.exceptions.ValidationError:
            return False
```

## Validation
```python
def test_specialized_processors():
    # Test markdown processor
    processor = MarkdownProcessor(config)
    result = await processor.process(
        "# Test\n\nContent",
        ProcessingContext(
            content_type="markdown",
            metadata={},
            options={}
        )
    )
    assert "<h1>Test</h1>" in result.content
    
    # Test JSON processor
    processor = JsonProcessor(config)
    result = await processor.process(
        '{"key": "value"}',
        ProcessingContext(
            content_type="json",
            metadata={},
            options={}
        )
    )
    assert result.content == {"key": "value"}
    
    # Test YAML processor
    processor = YamlProcessor(config)
    result = await processor.process(
        "key: value",
        ProcessingContext(
            content_type="yaml",
            metadata={},
            options={}
        )
    )
    assert result.content == {"key": "value"}
    
    # Test XML processor
    processor = XmlProcessor(config)
    result = await processor.process(
        "<root><item>value</item></root>",
        ProcessingContext(
            content_type="xml",
            metadata={},
            options={}
        )
    )
    assert result.content.find("item").text == "value"
    
    # Test content type detection
    utils = ProcessingUtils()
    assert utils.detect_content_type('{"key": "value"}') == "json"
    assert utils.detect_content_type("key: value") == "yaml"
    assert utils.detect_content_type("# Title") == "markdown"
    assert utils.detect_content_type("<root></root>") == "xml"
```

## Success Metrics
- [ ] Processadores especializados implementados
- [ ] Sistema de detec√ß√£o de tipo funcionando
- [ ] Valida√ß√£o de schema implementada
- [ ] Testes unit√°rios passando
- [ ] Documenta√ß√£o completa
- [ ] Zero duplica√ß√µes de c√≥digo

# Progress Updates

## 2024-02-26
- Status: üìã To Do
- Next Steps:
  1. Implementar processadores especializados
  2. Implementar f√°brica de processadores
  3. Implementar utilit√°rios
  4. Criar testes
  5. Atualizar documenta√ß√£o