---
title: Reestruturação de Capabilities e Events
task: TASK-007
code: R003
status: ✅ Done
created: 2024-02-22
updated: 2024-02-23
started: 2024-02-23
completed: 2024-02-23
---

# Requirement
Reestruturar o sistema de capabilities e events, consolidando funcionalidades dispersas e eliminando duplicações.

# Dependencies
- Conclusão do R002 (Providers)
- Mapeamento de capabilities existentes
- Análise de eventos e handlers

## Current State
```python
# Módulo capabilities/ com arquivos dispersos
# Capabilities em core/providers que deveriam estar em capabilities/
# Duplicação entre events/ e core/events/
```

## Implementation
- [x] Mover capabilities de `core/providers/` para `capabilities/`
  - [x] Criar diretório `capabilities/providers/`
  - [x] Criar base unificada em `capabilities/providers/base.py`
  - [x] Migrar funcionalidades comuns
- [x] Consolidar eventos:
  - [x] Unificar `core/events/base.py` com `events/base.py`
  - [x] Unificar `core/events/middleware.py` com `events/middleware.py`
  - [x] Mover handlers unificados para `events/handlers/`
- [x] Estrutura final:
  ```
  capabilities/
  ├── __init__.py
  ├── base.py
  ├── types.py
  └── providers/      # Movido de core/providers

  events/
  ├── __init__.py
  ├── base.py        # Unificado
  ├── dispatcher.py
  ├── middleware.py  # Unificado
  ├── handlers/
  └── hooks/
  ```

## Validation
```python
def test_capabilities_and_events():
    # Verificar capabilities
    from pepperpy.capabilities.providers import ProviderCapability
    assert ProviderCapability is not None
    
    # Verificar eventos unificados
    from pepperpy.events import EventDispatcher
    assert EventDispatcher.get_handlers() is not None
    
    # Verificar middleware
    from pepperpy.events.middleware import EventMiddleware
    assert EventMiddleware.process_event("test") is not None
    
    # Verificar que diretórios antigos foram removidos
    import os
    assert not os.path.exists("pepperpy/core/events")
    assert not os.path.exists("pepperpy/core/providers/capabilities")
```

## Rollback Plan
1. Backup de todos os arquivos de capabilities e events
2. Script para restaurar estrutura original:
   ```python
   def restore_structure():
       # Restaurar capabilities
       shutil.copytree("backup/capabilities", "pepperpy/capabilities")
       shutil.copytree("backup/core/providers", "pepperpy/core/providers")
       
       # Restaurar events
       shutil.copytree("backup/events", "pepperpy/events")
       shutil.copytree("backup/core/events", "pepperpy/core/events")
   ```
3. Testes de regressão para validar restauração

## Success Metrics
- [x] 100% das capabilities migradas
- [x] Sistema de eventos unificado
- [x] Zero duplicações de código
- [x] Todos os testes passando
- [x] Documentação atualizada
- [x] APIs públicas mantidas

# Progress Updates

## 2024-02-22
- Status: Planejamento inicial
- Progress: Mapeamento de capabilities e eventos 

## 2024-02-23
- Status: Implementação concluída
- Progress:
  - Criada estrutura de capabilities/providers
  - Migrado código de providers para capabilities
  - Consolidado sistema de eventos
  - Unificada base de eventos
  - Unificado middleware
  - Removido diretório core/events
  - Atualizada documentação 