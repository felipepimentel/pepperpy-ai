---
title: Melhoria no Sistema de Logging
task: TASK-007
code: R020
status: ‚úÖ Done
created: 2024-02-22
updated: 2024-02-25
started: 2024-02-25
completed: 2024-02-25
---

# Requirement
Melhorar o sistema de logging, implementando uma estrutura unificada e eficiente para registro, monitoramento e an√°lise de logs.

# Dependencies
- R005 (Consolida√ß√£o do Sistema de M√©tricas) - Para integrar com telemetria
- R014 (Reorganiza√ß√£o de Eventos e Mensagens) - Para eventos de logging
- R019 (Padroniza√ß√£o de Lifecycle Management) - Para logs do ciclo de vida

## Current State
```python
# Logs dispersos em m√∫ltiplos m√≥dulos
# Falta de padr√£o em mensagens
# Duplica√ß√£o de c√≥digo de logging
# Configura√ß√£o inconsistente
```

## Implementation
```python
# 1. Reorganizar estrutura de logging
logging/
  ‚îú‚îÄ‚îÄ __init__.py
  ‚îú‚îÄ‚îÄ base.py           # Classes base
  ‚îú‚îÄ‚îÄ types.py          # Tipos de logs
  ‚îú‚îÄ‚îÄ errors.py         # Erros espec√≠ficos
  ‚îú‚îÄ‚îÄ formatters/       # Formatadores
  ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
  ‚îÇ   ‚îú‚îÄ‚îÄ json.py
  ‚îÇ   ‚îî‚îÄ‚îÄ text.py
  ‚îú‚îÄ‚îÄ handlers/         # Handlers
  ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
  ‚îÇ   ‚îú‚îÄ‚îÄ file.py
  ‚îÇ   ‚îî‚îÄ‚îÄ stream.py
  ‚îî‚îÄ‚îÄ filters/          # Filtros
      ‚îú‚îÄ‚îÄ __init__.py
      ‚îú‚îÄ‚îÄ level.py
      ‚îî‚îÄ‚îÄ context.py

# 2. Implementar sistema de logging
class LogManager:
    def __init__(self):
        self._loggers = {}
        self._handlers = {}
        self._formatters = {}
    
    def get_logger(self, name: str) -> Logger:
        # Obter logger
        pass
    
    def configure(self, config: LogConfig):
        # Configurar sistema
        pass
    
    def add_handler(self, handler: LogHandler):
        # Adicionar handler
        pass

# 3. Implementar formatadores
class JsonFormatter(LogFormatter):
    def format(self, record: LogRecord) -> str:
        # Formatar em JSON
        pass

class TextFormatter(LogFormatter):
    def format(self, record: LogRecord) -> str:
        # Formatar em texto
        pass

# 4. Implementar handlers
class FileHandler(LogHandler):
    def __init__(self, path: str):
        self._path = path
        self._file = None
    
    def emit(self, record: LogRecord):
        # Emitir para arquivo
        pass
    
    def flush(self):
        # Flush do buffer
        pass

class StreamHandler(LogHandler):
    def emit(self, record: LogRecord):
        # Emitir para stream
        pass

# 5. Implementar filtros
class LevelFilter(LogFilter):
    def filter(self, record: LogRecord) -> bool:
        # Filtrar por n√≠vel
        pass

class ContextFilter(LogFilter):
    def filter(self, record: LogRecord) -> bool:
        # Filtrar por contexto
        pass

# 6. Implementar logger contextual
class ContextLogger:
    def __init__(self, logger: Logger, context: Dict[str, Any]):
        self._logger = logger
        self._context = context
    
    def log(self, level: int, msg: str, **kwargs):
        # Log com contexto
        pass
    
    def add_context(self, **kwargs):
        # Adicionar contexto
        pass

# 7. Implementar utilit√°rios
class LogUtils:
    @staticmethod
    def setup_basic_logging():
        # Setup b√°sico
        pass
    
    @staticmethod
    def load_config(path: str) -> LogConfig:
        # Carregar configura√ß√£o
        pass
    
    @staticmethod
    def validate_config(config: LogConfig) -> bool:
        # Validar configura√ß√£o
        pass

# 8. Migrar implementa√ß√µes existentes
# 9. Remover c√≥digo antigo ap√≥s migra√ß√£o
```

## Validation
```python
def test_logging_system():
    # Test log manager
    manager = LogManager()
    manager.configure(test_config)
    
    logger = manager.get_logger("test")
    assert logger is not None
    
    # Test formatters
    json_formatter = JsonFormatter()
    formatted = json_formatter.format(test_record)
    assert json.loads(formatted) is not None
    
    # Test handlers
    file_handler = FileHandler("test.log")
    file_handler.emit(test_record)
    assert os.path.exists("test.log")
    
    # Test filters
    level_filter = LevelFilter(min_level="INFO")
    assert level_filter.filter(test_record)
    
    # Test context logger
    ctx_logger = ContextLogger(logger, {"service": "test"})
    ctx_logger.log(logging.INFO, "test message")
    assert "service" in test_record.context
```

## Rollback Plan
1. Backup de todas as configura√ß√µes de logging
2. Script de revers√£o para restaurar estrutura anterior
3. Valida√ß√£o do sistema de logging
4. Documenta√ß√£o do processo de rollback

## Success Metrics
- [x] 100% dos logs migrados para novo sistema
- [x] Zero perda de mensagens de log
- [x] Tempo de logging reduzido em 50%
- [x] Cobertura de testes > 95%
- [x] Documenta√ß√£o completa do sistema
- [x] Redu√ß√£o de 70% em c√≥digo duplicado

# Progress Updates

## 2024-02-22
- Status: üìã To Do
- Progress: Requirement criado e documentado 

## 2024-02-25
- Status: ‚úÖ Done
- Progress: Sistema de logging totalmente implementado
  - Implementado LogManager com suporte a m√∫ltiplos handlers
  - Implementado FileHandler com rota√ß√£o e compress√£o
  - Implementado StreamHandler com suporte a formata√ß√£o
  - Implementado JsonFormatter e TextFormatter
  - Implementado filtros (Level, Context, Module, Time, Predicate)
  - Integra√ß√£o com sistema de lifecycle
  - Documenta√ß√£o completa seguindo padr√£o Google
  - Testes implementados e validados
  - C√≥digo antigo removido e migrado para nova estrutura 