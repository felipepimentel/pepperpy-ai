---
title: ReorganizaÃ§Ã£o de Eventos e Mensagens
task: TASK-007
code: R014
status: ğŸ“‹ To Do
created: 2024-02-22
updated: 2024-02-22
started: null
completed: null
---

# Requirement
Reorganizar o sistema de eventos e mensagens, implementando uma estrutura clara e eficiente para comunicaÃ§Ã£o entre componentes.

# Dependencies
- R003 (ReestruturaÃ§Ã£o de Capabilities e Events) - Para integrar com o novo sistema de eventos
- R004 (ConsolidaÃ§Ã£o do Sistema de Protocolos) - Para garantir compatibilidade com protocolos
- R008 (ConsolidaÃ§Ã£o de Agents e Workflows) - Para integrar eventos de agentes e workflows

## Current State
```python
# Eventos dispersos em mÃºltiplos mÃ³dulos
# DuplicaÃ§Ã£o de handlers e listeners
# Falta de padronizaÃ§Ã£o em mensagens
# Sistema de eventos nÃ£o escalÃ¡vel
```

## Implementation
```python
# 1. Reorganizar estrutura de eventos
events/
  â”œâ”€â”€ __init__.py
  â”œâ”€â”€ base.py           # Classes base
  â”œâ”€â”€ types.py          # Tipos de eventos
  â”œâ”€â”€ errors.py         # Erros especÃ­ficos
  â”œâ”€â”€ registry.py       # Registro de eventos
  â”œâ”€â”€ handlers/         # Handlers de eventos
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ base.py
  â”‚   â”œâ”€â”€ agent.py
  â”‚   â””â”€â”€ workflow.py
  â”œâ”€â”€ listeners/        # Listeners de eventos
  â”‚   â”œâ”€â”€ __init__.py
  â”‚   â”œâ”€â”€ base.py
  â”‚   â””â”€â”€ metrics.py
  â””â”€â”€ messages/         # DefiniÃ§Ãµes de mensagens
      â”œâ”€â”€ __init__.py
      â”œâ”€â”€ base.py
      â””â”€â”€ types.py

# 2. Implementar sistema de eventos
class EventBus:
    def __init__(self):
        self._handlers = {}
        self._listeners = {}
    
    def publish(self, event: Event):
        # Publicar evento para handlers e listeners
        pass
    
    def subscribe(self, event_type: Type[Event], handler: EventHandler):
        # Registrar handler para tipo de evento
        pass
    
    def add_listener(self, listener: EventListener):
        # Adicionar listener global
        pass

# 3. Implementar sistema de mensagens
class MessageBroker:
    def __init__(self):
        self._queues = {}
        self._processors = {}
    
    def send(self, message: Message):
        # Enviar mensagem para fila apropriada
        pass
    
    def register_processor(self, queue: str, processor: MessageProcessor):
        # Registrar processador para fila
        pass
    
    def start_processing(self):
        # Iniciar processamento de mensagens
        pass

# 4. Implementar handlers padrÃ£o
class AgentEventHandler(EventHandler):
    def handle(self, event: AgentEvent):
        # Processar evento de agente
        pass

class WorkflowEventHandler(EventHandler):
    def handle(self, event: WorkflowEvent):
        # Processar evento de workflow
        pass

# 5. Implementar listeners padrÃ£o
class MetricsListener(EventListener):
    def on_event(self, event: Event):
        # Coletar mÃ©tricas do evento
        pass

class LoggingListener(EventListener):
    def on_event(self, event: Event):
        # Registrar evento no log
        pass

# 6. Migrar eventos existentes
# 7. Remover cÃ³digo antigo apÃ³s migraÃ§Ã£o
```

## Validation
```python
def test_event_system():
    # Test event bus
    bus = EventBus()
    handler = AgentEventHandler()
    bus.subscribe(AgentEvent, handler)
    
    event = AgentEvent(agent_id="test")
    bus.publish(event)
    
    # Test message broker
    broker = MessageBroker()
    processor = TestProcessor()
    broker.register_processor("test_queue", processor)
    
    message = TestMessage(content="test")
    broker.send(message)
    
    # Test listeners
    metrics = MetricsListener()
    bus.add_listener(metrics)
    assert metrics.last_event == event
    
    # Test handlers
    workflow_handler = WorkflowEventHandler()
    workflow_event = WorkflowEvent(workflow_id="test")
    workflow_handler.handle(workflow_event)
```

## Rollback Plan
1. Backup de todos os eventos e mensagens
2. Script de reversÃ£o para restaurar estrutura anterior
3. ValidaÃ§Ã£o do sistema de eventos
4. DocumentaÃ§Ã£o do processo de rollback

## Success Metrics
- [ ] 100% dos eventos migrados para nova estrutura
- [ ] Zero perda de eventos durante migraÃ§Ã£o
- [ ] LatÃªncia de eventos reduzida em 40%
- [ ] Cobertura de testes > 95%
- [ ] DocumentaÃ§Ã£o completa do sistema
- [ ] ReduÃ§Ã£o de 50% em cÃ³digo duplicado

# Progress Updates

## 2024-02-22
- Status: ğŸ“‹ To Do
- Progress: Requirement criado e documentado 